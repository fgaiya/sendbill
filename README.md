# SendBill - 見積書・請求書管理システム

フリーランス・個人事業主向けの見積書・請求書作成・管理Webアプリケーション。SaaSモデルによるプラン体系と使用量制限機能を搭載し、効率的なビジネス文書管理ソリューションを提供します。

## 🎯 概要

個人利用を前提とした見積書・請求書管理システム。1ユーザー1会社の構成で、効率的な帳票作成と管理、Stripe決済による柔軟なプラン体系により、フリーランス・個人事業主のビジネス文書管理の完全なデジタル化を実現します。

### 🌟 主な特徴

- ✅ **プラン体系**: Free（10件/月）・Pro（1000件/月）の使用量制限
- ✅ **Stripe決済統合**: オンライン決済・サブスクリプション管理・即時解約
- ✅ **見積書・請求書管理**: 作成・編集・複製・変換・自動採番
- ✅ **取引先管理**: 顧客情報の一元管理・検索機能
- ✅ **税計算エンジン**: インボイス制度対応・複数税率・割引計算
- ✅ **印刷プレビュー**: ブラウザ印刷機能による帳票PDF保存
- ✅ **リアルタイムUI**: 使用量インジケーター・即時反映・イベント駆動
- ✅ **セキュリティ**: Clerk認証・タイミング攻撃対策・入力値検証

## 🏗️ 技術スタック

### フロントエンド
- **Framework**: Next.js 15 (App Router)
- **Language**: TypeScript (strict mode)
- **UI Library**: React 19
- **Styling**: Tailwind CSS v4
- **Components**: shadcn/ui
- **Fonts**: Geist (Sans & Mono)

### バックエンド
- **Runtime**: Node.js / Cloudflare Workers対応
- **Database**: PostgreSQL with Prisma Accelerate
- **ORM**: Prisma ORM
- **Authentication**: Clerk
- **Payment**: Stripe API（REST実装）

### 開発・品質
- **Validation**: Zod
- **Testing**: Jest + React Testing Library
- **Linting**: ESLint + TypeScript
- **Architecture**: Domain-Driven Design

## 💼 プラン・課金システム

### プラン体系
| プラン | 月間帳票作成数 | 料金 |
|--------|----------------|------|
| **Free** | 10件 | 無料 |
| **Pro** | 1,000件 | 有料 |

### 使用量制限・監視
- **リアルタイム使用量表示**: ヘッダーに常時表示
- **段階的警告**: 80%到達時に警告表示
- **グレース機能**: 上限到達時の猶予枠（3件）
- **ソフトブロック**: 超過時は402エラー・閲覧は継続可能

### Stripe決済統合
- **Checkout Session**: 安全な決済フロー
- **Webhook対応**: リアルタイム状態同期
- **即時解約**: キャンセル時の即座なFree移行
- **セキュリティ**: 署名検証・タイミング攻撃対策・冪等性保証

## 🚀 主要機能

### 1. 認証システム
- **Clerk統合**: メール・パスワード認証
- **ソーシャルログイン**: Google・GitHub対応
- **セキュリティ**: MFA・セッション管理

### 2. 会社情報管理
- **基本情報**: 会社名・屋号・住所・電話番号
- **インボイス対応**: 登録番号・標準/軽減税率設定
- **振込先情報**: 銀行口座・支払い条件設定
- **ロゴ管理**: 会社ロゴのアップロード

### 3. 取引先管理
- **CRUD操作**: 作成・編集・削除・検索
- **詳細情報**: 会社名・担当者・住所・連絡先
- **検索機能**: 名前・フリガナ・メール・電話番号
- **取引履歴**: 関連帳票の表示

### 4. 見積書管理
- **作成・編集**: 件名・発行日・有効期限・品目管理
- **ステータス管理**: 下書き→送付済み→受注/失注
- **自動採番**: 送付時の番号自動生成
- **複製機能**: 既存見積書からの複製・請求書への変換
- **税計算**: 行別税率・割引・複数税率対応

### 5. 請求書管理
- **作成・編集**: 件名・発行日・支払期限・品目管理
- **ステータス管理**: 下書き→送付済み→入金済み
- **見積書変換**: 見積書からの請求書生成
- **分割請求**: 1つの見積書から複数請求書作成
- **期限管理**: 支払期限の自動計算・警告

### 6. 印刷・PDF機能
- **印刷プレビュー**: 専用レイアウトでの印刷画面
- **PDF保存**: ブラウザの印刷機能でPDF出力
- **インボイス形式**: 法的要件準拠の帳票レイアウト

### 7. 検索・絞り込み
- **統合検索**: 帳票・取引先の横断検索
- **フィルタ機能**: ステータス・期間・取引先別
- **ソート機能**: 日付・金額・ステータス順

## 📊 データ設計

### メインエンティティ
- **Company**: 会社情報・プラン・Stripe連携
- **User**: ユーザー情報・Clerk統合
- **Client**: 取引先情報
- **Quote**: 見積書・品目・税計算
- **Invoice**: 請求書・品目・支払い管理
- **UsageCounter**: 使用量メーター・期間管理

### 設計特徴
- **1対1関係**: 1ユーザー1会社の厳密な分離
- **楽観ロック**: 同時編集時の競合制御
- **論理削除**: データの安全な削除
- **監査ログ**: 重要操作の履歴管理

## 🔧 システム特徴

### Cloudflare Workers対応
- **エッジ実行**: 高速レスポンス・グローバル配信
- **トランザクション回避**: updateManyによる冪等処理
- **軽量実装**: 最小依存関係・高速起動

### セキュリティ
- **認証・認可**: Clerk統合・セッション管理
- **入力検証**: Zod スキーマ・XSS対策
- **CSRF対策**: Next.js標準機能
- **支払いセキュリティ**: webhook署名検証・タイミング攻撃対策

### パフォーマンス
- **イベント駆動UI**: 必要時のみ更新・結合度の低減
- **ヘッダー活用**: API呼び出し削減・即時反映
- **自己修復**: プラン変更時の自動同期

## 🎨 UI/UX設計

### デザイン原則
- **日本語ファースト**: 完全な日本語対応
- **アクセシビリティ**: WCAG 2.1準拠・キーボードナビゲーション
- **レスポンシブ**: モバイル・タブレット完全対応
- **使いやすさ**: 直感的な操作・明確な導線

### コンポーネント
- **統一デザイン**: shadcn/ui ベース・一貫したスタイル
- **フォーム**: React Hook Form + Zod・リアルタイムバリデーション
- **テーブル**: ソート・フィルタ・ページネーション
- **モーダル**: アクセシブルな操作・Escapeキー対応

## 📁 プロジェクト構成

```
SendBill/
├── app/                      # Next.js App Router
│   ├── (auth)/               # 認証ページ（サインイン・アップ）
│   ├── api/                  # API Routes
│   │   ├── billing/          # 課金・使用量API
│   │   ├── clients/          # 取引先管理API
│   │   ├── companies/        # 会社管理API
│   │   ├── quotes/           # 見積書管理API
│   │   ├── invoices/         # 請求書管理API
│   │   └── webhooks/         # Clerk・Stripe Webhook
│   └── dashboard/            # ダッシュボード・管理画面
├── components/               # UIコンポーネント
│   ├── ui/                   # shadcn/ui基盤コンポーネント
│   ├── layout/               # レイアウトコンポーネント
│   ├── domains/              # ドメイン別UIコンポーネント
│   └── features/             # 機能別UIコンポーネント
├── lib/                      # ビジネスロジック層
│   ├── shared/               # 共通ライブラリ
│   ├── domains/              # ドメイン別ビジネスロジック
│   └── features/             # 機能別ビジネスロジック
├── prisma/                   # データベース設定
└── docs/                     # ドキュメント
```

### アーキテクチャ特徴
- **Domain-Driven Design**: ビジネスドメインに基づく設計
- **関心の分離**: 技術層・ドメイン層の明確な分離
- **型安全性**: TypeScript strict mode・完全な型定義

## ⚙️ 環境設定

### 必須環境変数
```bash
# データベース
DATABASE_URL="postgresql://..."

# 認証（Clerk）
NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY="pk_..."
CLERK_SECRET_KEY="sk_..."
CLERK_WEBHOOK_SECRET="whsec_..."

# 決済（Stripe）
BILLING_FEATURE_STRIPE=true
STRIPE_SECRET_KEY="sk_..."
STRIPE_PRICE_PRO_MONTHLY="price_..."
STRIPE_WEBHOOK_SECRET="whsec_..."
APP_BASE_URL="https://yourdomain.com"

# 使用量制限
BILLING_FREE_MONTHLY_DOC_LIMIT=10
BILLING_PRO_MONTHLY_DOC_LIMIT=1000
BILLING_WARN_PERCENT=0.8
BILLING_GRACE_UNITS_DOCUMENT=3
BILLING_FEATURE_WATERMARK=true
```

## 🔒 セキュリティ・コンプライアンス

### データ保護
- **暗号化**: 機密情報の保存時・転送時暗号化
- **アクセス制御**: 会社単位でのデータ分離
- **監査ログ**: 重要操作の追跡・ログ記録

### 支払いセキュリティ
- **PCI DSS準拠**: Stripe経由・カード情報非保存
- **webhook検証**: HMAC-SHA256署名検証
- **タイミング攻撃対策**: 定時間比較実装

### インボイス制度対応
- **適格請求書**: 法的要件準拠の帳票形式
- **税率管理**: 標準・軽減税率の適切な処理
- **登録番号**: インボイス登録番号の管理

## 📈 今後の展開

### 短期改善項目
- **PDF出力API**: サーバーサイドPDF生成・ウォーターマーク対応
- **通知機能**: メール・Slack通知

### 中長期展開
- **API公開**: 他システムとの連携
- **モバイルアプリ**: iOS・Android対応
- **エンタープライズ**: チーム・権限管理機能

---

**対象ユーザー**: フリーランス・個人事業主・小規模企業  
**利用形態**: 個人利用（1ユーザー1会社）  
**ライセンス**: MIT License